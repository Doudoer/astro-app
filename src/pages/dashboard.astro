---
const title = 'Dashboard';
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
  <link rel="icon" type="image/png" href="/src/img/favicon.png" />
    <link rel="stylesheet" href="/src/styles/tailwind.css">
    <style>
      :root{--bg:#f7f7f8;--card:#ffffff;--text:#111827;--muted:#6b7280;--accent:#111827}
      body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:var(--bg);color:var(--text);margin:0}
      .navbar{height:64px;background:var(--card);display:flex;align-items:center;justify-content:space-between;padding:0 20px;box-shadow:0 6px 20px rgba(17,24,39,0.06)}
      .brand{display:flex;align-items:center;gap:12px}
      .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#111827, #374151);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  .navcenter{display:flex;gap:12px;align-items:center}
  .navcenter a{padding:8px 12px;border-radius:8px;color:var(--muted);text-decoration:none;transition:all 160ms cubic-bezier(.2,.8,.2,1);display:inline-flex;align-items:center;gap:8px}
  .navcenter a svg{width:16px;height:16px;flex-shrink:0;transition:transform 180ms, fill 180ms, opacity 180ms}
  .navcenter a:hover{color:var(--text);background:rgba(17,24,39,0.03);transform:translateY(-2px);box-shadow:0 6px 18px rgba(2,6,23,0.04)}
  .navcenter a:hover svg{transform:scale(1.08);opacity:0.95}
  .navcenter a:focus{outline:2px solid rgba(17,24,39,0.06);outline-offset:4px}
  .navcenter a.active{color:var(--text);background:rgba(17,24,39,0.03)}
  .product-result.active{background:rgba(17,24,39,0.04);}
  input[disabled], input:disabled{background:#f3f4f6;color:#9ca3af;border-color:#e6e7eb}
      .profile{position:relative}
  .profilebutton{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;cursor:pointer}
  .profilebutton svg{width:16px;height:16px}
  .dropdown{position:absolute;right:0;top:calc(100% + 8px);background:var(--card);box-shadow:0 10px 30px rgba(2,6,23,0.08);border-radius:10px;overflow:hidden;display:none;min-width:200px}
  .dropdown a{display:flex;align-items:center;gap:10px;padding:10px 14px;color:var(--text);text-decoration:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:14px}
  .dropdown a svg{width:16px;height:16px;opacity:0.9;transition:transform 160ms, fill 160ms}
  .dropdown a:hover svg{transform:translateX(4px)}
  .dropdown a:hover{background:#f3f4f6;color:var(--text)}
  .dropdown a + a{border-top:1px solid #f1f1f1}
  /* Button styling mapped to global .btn classes (defined in src/styles/tailwind.css) */
  /* Use .btn + variant classes in markup: .btn-primary, .btn-danger, .btn-ghost, .btn-secondary */
  button { /* keep native buttons accessible by default */ }
  .btn { /* base button styles live in src/styles/tailwind.css */ }
  .btn-success { /* legacy name -> map to primary */ }
  .btn-success { background-color: #14b8a6; color: #fff; }
  .btn-danger { background-color: #ef4444; color: #fff; }
  .btn-secondary { background-color: #ffffff; color: var(--text); border: 1px solid #e6e7eb; }
  .btn, .btn-success, .btn-danger, .btn-secondary { transition: transform .12s ease, box-shadow .12s ease; }
  .btn:hover, .btn-success:hover, .btn-danger:hover, .btn-secondary:hover { transform: translateY(-2px); opacity: 0.96; }
  .btn:focus, .btn-success:focus, .btn-danger:focus, .btn-secondary:focus { outline: 2px solid rgba(17,24,39,0.08); outline-offset: 4px; }
  /* modal entry animation */
  @keyframes modalIn{ from{opacity:0;transform:translateY(-6px) scale(.995)} to{opacity:1;transform:translateY(0) scale(1)} }
  #productModal > div, #clientModal > div, #docModal > div{ animation: modalIn 180ms ease both; transform-origin: center top }
  /* button active press */
  .btn-success:active, .btn-danger:active, .btn-primary:active{ transform:translateY(0); opacity:0.92 }
      .container{max-width:1100px;margin:28px auto;padding:0 20px}

      /* Responsive */
  .hamburger{display:none;align-items:center;justify-content:center;width:40px;height:40px;border-radius:8px;cursor:pointer}
  .mobile-enter{animation: slideFadeIn 220ms ease forwards;z-index:1000}
  .mobile-leave{animation: slideFadeOut 180ms ease forwards}
  @keyframes slideFadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
  @keyframes slideFadeOut{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-6px)}}
      @media (max-width:800px){
        .navcenter{display:none}
        .hamburger{display:flex}
        .profilebutton{padding:10px}
        .dropdown{right:8px;left:8px;min-width:auto;border-radius:8px;position:fixed;top:64px;z-index:1200}
        .dropdown a{font-size:16px;padding:14px}
      }
    /* Card buttons - modern look for Ver / Editar / Eliminar */
    .card-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-size:13px;font-weight:600;transition:transform .12s ease,box-shadow .12s ease;color:var(--card);box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .card-btn svg{width:14px;height:14px;flex-shrink:0;opacity:0.95}
    .card-btn--primary{background:linear-gradient(90deg,#06b6d4,#10b981);color:#fff}
    .card-btn--danger{background:#ef4444;color:#fff}
    .card-btn--ghost{background:transparent;color:var(--text);border:1px solid #e6e7eb;box-shadow:none}
    .card-btn:hover{transform:translateY(-3px);box-shadow:0 10px 28px rgba(2,6,23,0.08)}
    .card-btn:active{transform:translateY(0);opacity:0.95}
    .card-btn--small{padding:6px 10px;font-size:13px;border-radius:6px}
    
    /* Responsive fixes: prevent cards overflowing on small screens */
    *, *::before, *::after { box-sizing: border-box; }

    /* make sure cards never exceed container width and text wraps */
    .product-card, .client-card, .doc-card, .card { width: 100%; max-width: 100%; box-sizing: border-box; }
    .product-card > *, .client-card > *, .doc-card > * { word-break: break-word; overflow-wrap: anywhere; }

    /* ensure badges and inline elements don't force horizontal scroll */
    .bcv-badge, .usd-badge { display: inline-block; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* small-screen specific adjustments */
    @media (max-width: 640px) {
      .container{padding:12px}
      .navbar{padding:0 12px}
      /* make stats collapse to one column on very small screens */
      #stats{grid-template-columns: 1fr}
      /* ensure grids are single-column and cards stack nicely */
      #docsGrid, #productsGrid, #clientsGrid{grid-template-columns: 1fr; gap:12px}
      /* reduce card padding and radius to fit small widths */
      .product-card, .client-card, .doc-card{padding:10px !important;border-radius:8px !important;min-height:unset}
      /* make flex rows wrap instead of overflowing */
      .product-card, .client-card, .doc-card{display:flex;flex-direction:column;}
      .product-card > div, .client-card > div, .doc-card > div{width:100%}
      /* shrink buttons slightly */
      .card-btn{padding:6px 10px;font-size:13px}
      /* tooltip max width */
      #bcv-tooltip{max-width:calc(100% - 32px)}
    }
    /* hide admin-only delete controls for non-admin users (body.role-user) */
    body.role-user .delProd, body.role-user .delClient, body.role-user .delUser, body.role-user #deleteDoc { display: none !important; }
    </style>
  </head>
  <body>
    <header class="navbar">
      <div class="brand">
        <div class="logo">CHC</div>
        <div class="company">CHC App</div>
      </div>
      <nav class="navcenter">
        <a href="#" class="active" data-view="inicio"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-8.5z" fill="currentColor"/></svg>Inicio</a>
        <a href="#" data-view="crear"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>Crear documento</a>
        <a href="#" data-view="documentos"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.2"/><path d="M7 8h10" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>Documentos</a>
        <a href="#" data-view="inventario"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h18M5 7v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>Inventario</a>
        <a href="#" data-view="clientes"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 21v-2a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.2"/></svg>Clientes</a>
      </nav>
      <div style="display:flex;align-items:center;gap:8px">
  <div class="hamburger" id="hamburger" role="button" aria-controls="mobileMenu" aria-expanded="false" aria-label="Abrir menú" tabindex="0">☰</div>
  <div class="profile">
      <div id="headerAvatar" class="avatar small" title="Perfil">--</div>
      <div id="headerRoleBadge" class="role-badge user" style="margin-right:6px">user</div>
      <div>
        <div class="profilebutton" id="profileBtn" role="button" aria-haspopup="true" aria-expanded="false" tabindex="0">Perfil ▾</div>
      </div>
        <div class="dropdown" id="profileMenu">
          <a href="#" id="changePwd"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15v2" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/><path d="M16 11V9a4 4 0 1 0-8 0v2" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>Cambiar contraseña</a>
          <a href="#" id="createUser"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 14c1.657 0 3 1.343 3 3v1" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/><path d="M8 14a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke="currentColor" stroke-width="1.2"/><path d="M20 8v6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>Crear nuevos usuarios</a>
          <a href="#" id="viewUsers"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h18M5 7v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>Ver usuarios</a>
          <a href="#" id="logout"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 17l5-5-5-5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 12H9" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>Cerrar sesión</a>
        </div>
      </div>
    </header>
      <div id="mobileMenu" aria-hidden="true" style="display:none;background:var(--card);box-shadow:0 8px 30px rgba(0,0,0,0.06);padding:8px;border-radius:8px;margin:8px 12px">
        <nav role="menu" aria-label="Menú principal">
          <a role="menuitem" href="#" class="mobile-link" data-view="inicio"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-8.5z" fill="currentColor"/></svg><span>Inicio</span></a>
          <a role="menuitem" href="#" class="mobile-link" data-view="crear"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Crear documento</span></a>
          <a role="menuitem" href="#" class="mobile-link" data-view="documentos"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.2"/><path d="M7 8h10" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg><span>Documentos</span></a>
          <a role="menuitem" href="#" class="mobile-link" data-view="inventario"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h18M5 7v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Inventario</span></a>
          <a role="menuitem" href="#" class="mobile-link" data-view="clientes"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 21v-2a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.2"/></svg><span>Clientes</span></a>
        </nav>
      </div>

    <main class="container">
      <!-- Views rendered in-place -->
  <section id="view-inicio" class="view-section card" style="box-shadow:0 8px 30px rgba(0,0,0,0.06)">
        <h1>Bienvenido al Dashboard</h1>
        <p id="welcome">Cargando...</p>
  <div id="stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:18px">
          <div class="stat-card card" style="background:linear-gradient(180deg,#fff,#f8fafc);padding:16px;">
            <div style="font-size:13px;color:var(--muted)">Productos en catálogo</div>
            <div id="stat-products" style="font-size:28px;font-weight:700;margin-top:8px">—</div>
          </div>
          <div class="stat-card card" style="background:linear-gradient(180deg,#fff,#f8fafc);padding:16px;">
            <div style="font-size:13px;color:var(--muted)">Clientes registrados</div>
            <div id="stat-clients" style="font-size:28px;font-weight:700;margin-top:8px">—</div>
          </div>
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div class="stat-card card" style="background:linear-gradient(180deg,#fff,#f8fafc);padding:16px;min-width:200px;margin-right:12px">
              <div style="font-size:13px;color:var(--muted)">Cotizaciones</div>
              <div id="stat-quotes" style="font-size:20px;font-weight:700;margin-top:8px">—</div>
              <div id="stat-quotes-amount" style="font-size:12px;color:var(--muted);margin-top:6px">— USD</div>
            </div>
            <div class="stat-card card" style="background:linear-gradient(180deg,#fff,#f8fafc);padding:16px;min-width:200px">
              <div style="font-size:13px;color:var(--muted)">Notas de Entregas</div>
              <div id="stat-notes" style="font-size:20px;font-weight:700;margin-top:8px">—</div>
              <div id="stat-notes-amount" style="font-size:12px;color:var(--muted);margin-top:6px">— USD</div>
            </div>
          </div>
          <div class="stat-card card" style="background:linear-gradient(180deg,#fff,#f8fafc);padding:16px;">
            <div style="font-size:13px;color:var(--muted)">Total ventas (USD) - Mes</div>
            <div id="stat-sales" style="font-size:28px;font-weight:700;margin-top:8px">—</div>
          </div>
          </div>
          <!-- Estadísticas avanzadas: colocado aquí para que permanezca dentro del mismo contenedor de tarjetas -->
          <div style="grid-column:1/-1;margin-top:12px;">
            <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
              <div style="flex:1;min-width:220px;max-width:320px;background:linear-gradient(180deg,#fff,#f8fafc);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.04)">
                <div style="font-size:13px;color:var(--muted)">Total ventas (ND)</div>
                <div id="adv-total-ventas" style="font-size:22px;font-weight:700;margin-top:8px">— USD</div>
                <div style="font-size:12px;color:var(--muted);margin-top:8px">Basado en Notas de Entrega (ND)</div>
              </div>
              <div style="flex:2;min-width:320px;max-width:760px;background:linear-gradient(180deg,#fff,#f8fafc);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.04)">
                <div style="font-size:13px;color:var(--muted)">Totales últimos 12 meses</div>
                <div id="adv-monthly" style="margin-top:8px;display:flex;gap:8px;align-items:end;overflow:auto;padding-bottom:8px"></div>
              </div>
              <div style="flex:1;min-width:260px;background:linear-gradient(180deg,#fff,#f8fafc);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.04)">
                <div style="font-size:13px;color:var(--muted)">Top compradores (mes actual)</div>
                <div id="adv-top-buyers" style="margin-top:8px"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

  <section id="view-crear" class="view-section card" style="display:none;box-shadow:0 8px 30px rgba(0,0,0,0.06)">
        <h1>Crear documento</h1>
        <form id="createDocForm">
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:160px">
              <label for="tipo">Tipo</label>
              <select id="tipo" name="tipo" style="width:100%;padding:10px;margin-top:6px;border:1px solid #e6e7eb;border-radius:8px">
                <option value="CT">CT - Cotización</option>
                <option value="ND">ND - Nota de Débito</option>
              </select>
            </div>
            <div style="flex:2;min-width:220px">
              <label for="cliente">Cliente</label>
              <select id="cliente" name="cliente" style="width:100%;padding:10px;margin-top:6px;border:1px solid #e6e7eb;border-radius:8px">
                <option value="">Cargando clientes...</option>
              </select>
            </div>
            <div style="min-width:160px">
              <label for="currency">Moneda</label>
              <select id="currency" name="currency" style="width:100%;padding:10px;margin-top:6px;border:1px solid #e6e7eb;border-radius:8px">
                <option value="USD">USD</option>
                <option value="VES">VES</option>
              </select>
            </div>
            <div style="min-width:160px">
              <label for="exchangeRate">Tasa (BCV)</label>
              <input id="exchangeRate" name="exchangeRate" type="number" step="0.000001" value="1.0" style="width:100%;padding:10px;margin-top:6px;border:1px solid #e6e7eb;border-radius:8px" />
              <div style="margin-top:6px;font-size:13px;color:var(--muted)"><span id="bcvRateDisplay" style="margin-left:12px"></span></div>
            </div>
          </div>

          <hr style="margin:16px 0" />

          <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap">
            <div style="flex:1;min-width:240px;position:relative">
              <label for="productSearch">Buscar producto</label>
              <input id="productSearch" placeholder="Código o descripción" autocomplete="off" aria-autocomplete="list" aria-controls="productResults" style="width:100%;padding:10px;margin-top:6px;border:1px solid #e6e7eb;border-radius:8px" />
              <div id="productResults" role="listbox" aria-label="Resultados de productos" style="display:none;position:absolute;left:0;right:0;top:100%;background:var(--card);box-shadow:0 8px 24px rgba(2,6,23,0.12);border-radius:8px;margin-top:8px;z-index:40;max-height:260px;overflow:auto;padding:6px"></div>
            </div>
            <div style="width:120px">
              <label for="qty">Cantidad</label>
              <input id="qty" type="number" step="1" min="1" value="1" style="width:100%;padding:10px;margin-top:6px;border:1px solid #e6e7eb;border-radius:8px" />
            </div>
            <div style="width:140px">
              <label for="unitPrice">P. Unit (USD)</label>
              <input id="unitPrice" type="number" step="0.0001" value="0.00" style="width:100%;padding:10px;margin-top:6px;border:1px solid #e6e7eb;border-radius:8px" />
            </div>
            <div>
              <button type="button" id="addItem" class="btn-primary">Agregar</button>
            </div>
          </div>

          <table id="itemsTable" style="width:100%;margin-top:12px;border-collapse:collapse">
            <thead>
              <tr style="text-align:left;border-bottom:1px solid #eef2f6"><th>Producto</th><th>Cantidad</th><th>P.Unit (USD)</th><th>Descuento</th><th>Total (USD)</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>

          <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:18px;align-items:center">
            <div style="text-align:right">
              <div id="usdTotals">
                <div>Subtotal USD: <span id="subtotal">0.00</span></div>
                <div>IVA 16%: <span id="tax">0.00</span></div>
                <div style="font-weight:700">Total USD: <span id="total">0.00</span></div>
              </div>
              <div id="bsfTotals" style="display:none">
                <div>Subtotal Bs.F: <span id="subtotalBsf">0.00</span></div>
                <div>IVA Bs.F: <span id="taxBsf">0.00</span></div>
                <div style="font-weight:700">Total Bs.F: <span id="totalBsf">0.00</span></div>
              </div>
              <div id="ivaNote" style="color:var(--muted);margin-top:8px;display:none">Estos precios no incluyen IVA</div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px">
            <button type="submit" class="btn-success">Guardar documento</button>
            <button type="button" id="cancelCreate" class="btn-secondary">Cancelar</button>
          </div>
          <div id="createResult" aria-live="polite" style="margin-top:12px"></div>
        </form>
      </section>

      <section id="view-documentos" class="view-section" style="display:none;background:var(--card);padding:28px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.06)">
        <h1>Documentos</h1>
        <div style="margin-top:12px">
          <!-- Grid of document cards -->
          <div id="docsGrid" class="cards-grid" style="display:grid;margin-top:12px"></div>
        </div>
        <!-- modal sencillo -->
        <div id="docModal" role="dialog" aria-hidden="true" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;padding:20px">
          <div style="background:var(--card);max-width:760px;width:100%;padding:18px;border-radius:10px;box-shadow:0 10px 40px rgba(2,6,23,0.2);position:relative">
              <button id="closeDocModal" class="btn-secondary" style="position:absolute;right:10px;top:10px">Cerrar</button>
            <h2 id="modalDocNumber">Documento</h2>
            <div id="modalBody">Cargando...</div>
            <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
              <button id="deleteDoc" class="btn-danger">Eliminar</button>
            </div>
          </div>
        </div>
      </section>

      <section id="view-inventario" class="view-section" style="display:none;background:var(--card);padding:28px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.06)">
        <h1>Inventario</h1>
        <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
          <!-- código generado automáticamente (no editable por el usuario) -->
          <div style="flex:2;min-width:220px">
            <label for="newDesc">Descripción</label>
            <input id="newDesc" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" />
          </div>
          <div style="width:140px">
            <label for="newPrice">Precio USD</label>
            <input id="newPrice" type="number" step="0.01" value="0.00" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" />
          </div>
          <div><button id="addProduct" class="btn-success">Agregar producto</button></div>
          <div style="min-width:180px">
            <label for="generatedCode">Código generado</label>
            <input id="generatedCode" readonly style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px;background:#f3f4f6" />
          </div>
        </div>

  <!-- Grid of product cards -->
  <div id="productsGrid" class="cards-grid" style="display:grid;margin-top:12px"></div>
        <!-- Product edit modal -->
        <div id="productModal" role="dialog" aria-hidden="true" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;padding:20px">
          <div style="background:var(--card);max-width:420px;width:100%;padding:18px;border-radius:10px;box-shadow:0 10px 40px rgba(2,6,23,0.2);position:relative">
            <button id="closeProductModal" class="btn-secondary" style="position:absolute;right:10px;top:10px">Cerrar</button>
            <h2>Editar producto</h2>
            <input id="editProdId" type="hidden" />
            <div style="margin-top:8px"><label>Código</label><input id="editProdCode" readonly style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px;background:#f3f4f6" /></div>
            <div style="margin-top:8px"><label>Descripción</label><input id="editProdDesc" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" /></div>
            <div style="margin-top:8px"><label>Precio USD</label><input id="editProdPrice" type="number" step="0.01" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" /></div>
            <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button id="saveProdModal" class="btn-success">Guardar</button><button id="cancelProdModal" class="btn-danger">Cancelar</button></div>
          </div>
        </div>
      </section>

      <section id="view-clientes" class="view-section" style="display:none;background:var(--card);padding:28px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.06)">
        <h1>Clientes</h1>
        <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
          <div style="flex:2;min-width:220px">
            <label for="clientName">Nombre</label>
            <input id="clientName" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" />
          </div>
          <div style="width:220px;display:flex;gap:8px;align-items:center">
            <div style="width:70px">
              <label for="clientRifType">Tipo</label>
              <select id="clientRifType" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px">
                <option value="V">V</option>
                <option value="E">E</option>
                <option value="J">J</option>
                <option value="G">G</option>
              </select>
            </div>
            <div style="flex:1">
              <label for="clientRifNumber">RIF/CI</label>
              <input id="clientRifNumber" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" />
            </div>
          </div>
          <div style="width:160px">
            <label for="clientPhone">Teléfono</label>
            <input id="clientPhone" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" />
          </div>
          <div style="flex:1;min-width:220px">
            <label for="clientAddress">Dirección</label>
            <input id="clientAddress" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" />
          </div>
          <div><button id="addClient" class="btn-success">Agregar cliente</button></div>
        </div>

  <!-- Grid of client cards -->
  <div id="clientsGrid" class="cards-grid" style="display:grid;margin-top:12px"></div>
        <!-- Client edit modal -->
        <div id="clientModal" role="dialog" aria-hidden="true" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;padding:20px">
          <div style="background:var(--card);max-width:520px;width:100%;padding:18px;border-radius:10px;box-shadow:0 10px 40px rgba(2,6,23,0.2);position:relative">
            <button id="closeClientModal" class="btn-secondary" style="position:absolute;right:10px;top:10px">Cerrar</button>
            <h2>Editar cliente</h2>
            <input id="editClientId" type="hidden" />
            <div style="margin-top:8px;display:flex;gap:8px;align-items:end">
              <div style="flex:1;min-width:200px"><label>Nombre</label><input id="editClientName" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" /></div>
              <div style="width:120px"><label>Tipo</label><select id="editClientRifType" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px"><option value="V">V</option><option value="E">E</option><option value="J">J</option><option value="G">G</option></select></div>
              <div style="flex:1;min-width:160px"><label>RIF/CI</label><input id="editClientRifNumber" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" /></div>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px;align-items:end">
              <div style="width:180px"><label>Teléfono</label><input id="editClientPhone" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" /></div>
              <div style="flex:1;min-width:200px"><label>Dirección</label><input id="editClientAddress" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" /></div>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button id="saveClientModal" class="btn-success">Guardar</button><button id="cancelClientModal" class="btn-danger">Cancelar</button></div>
          </div>
        </div>
      </section>
    </main>

    <!-- Confirm modal (reutilizable) -->
    <div id="confirmModal" role="dialog" aria-hidden="true" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;padding:20px">
      <div style="background:var(--card);max-width:420px;width:100%;padding:18px;border-radius:10px;box-shadow:0 10px 40px rgba(2,6,23,0.2);position:relative">
        <h3 id="confirmTitle">Confirmar</h3>
        <div id="confirmMessage" style="margin-top:8px;color:var(--muted)">¿Confirmar acción?</div>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button id="confirmOk" class="btn-success">Confirmar</button><button id="confirmCancel" class="btn-secondary">Cancelar</button></div>
      </div>
    </div>

  <script>
      const profileBtn = document.getElementById('profileBtn');
      const profileMenu = document.getElementById('profileMenu');
        profileBtn.addEventListener('click', ()=> {
          // ensure profile header exists inside dropdown
          try{
            if(profileMenu && !profileMenu.querySelector('.profile-head')){
              const headerAvatarInner = document.getElementById('headerAvatar') ? document.getElementById('headerAvatar').textContent : '';
              const headerName = document.getElementById('welcome') ? document.getElementById('welcome').textContent.replace(/^Hola,\s*/,'') : '';
              const headerRole = document.getElementById('headerRoleBadge') ? document.getElementById('headerRoleBadge').textContent : '';
              const ph = document.createElement('div'); ph.className='profile-head';
              ph.innerHTML = `<div class="avatar avatar-lg">${headerAvatarInner}</div><div class="profile-info"><div class="profile-name">${headerName}</div><div class="profile-role">${headerRole}</div></div>`;
              profileMenu.insertBefore(ph, profileMenu.firstChild);
              // style the new avatar from the headerAvatar element
              const srcAvatar = document.getElementById('headerAvatar');
              if(srcAvatar){ const newAv = profileMenu.querySelector('.avatar.avatar-lg'); if(newAv) newAv.style.background = srcAvatar.style.background; }
            }
          }catch(e){}
          const open = profileMenu.style.display !== 'block';
          profileMenu.style.display = open ? 'block' : 'none';
          profileBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
        });
        profileBtn.addEventListener('keydown',(e)=>{ if(e.key === 'Enter' || e.key === ' ') profileBtn.click(); });
  const hamburger = document.getElementById('hamburger');
  const mobileMenu = document.getElementById('mobileMenu');
    if(hamburger){
      hamburger.addEventListener('click', ()=>{
        const open = mobileMenu.style.display !== 'block';
        if(open){
          mobileMenu.style.display = 'block';
          mobileMenu.classList.remove('mobile-leave');
          mobileMenu.classList.add('mobile-enter');
          mobileMenu.setAttribute('aria-hidden','false');
          hamburger.setAttribute('aria-expanded','true');
          hamburger.setAttribute('aria-label','Cerrar menú');
          // ensure profile dropdown closed when mobile menu opens
          profileMenu.style.display = 'none';
          profileBtn.setAttribute('aria-expanded','false');
            // focus first menu item for keyboard users
            const first = mobileMenu.querySelector('[role="menuitem"]');
            if(first) first.focus();
        } else {
          mobileMenu.classList.remove('mobile-enter');
          mobileMenu.classList.add('mobile-leave');
          hamburger.setAttribute('aria-expanded','false');
          mobileMenu.setAttribute('aria-hidden','true');
          hamburger.setAttribute('aria-label','Abrir menú');
          setTimeout(()=> mobileMenu.style.display = 'none', 190);
        }
      });
      hamburger.addEventListener('keydown',(e)=>{ if(e.key === 'Enter' || e.key === ' ') hamburger.click(); });
    }

  // Close mobile menu when selecting an item and make links keyboard/touch friendly
  const mobileLinks = document.querySelectorAll('#mobileMenu [role="menuitem"]');
  mobileLinks.forEach(link => {
      // make focus styles available
      link.setAttribute('tabindex','0');
      link.addEventListener('click', ()=>{
        // close mobile menu on selection (small delay to allow navigation)
        mobileMenu.classList.remove('mobile-enter');
        mobileMenu.classList.add('mobile-leave');
        mobileMenu.setAttribute('aria-hidden','true');
        hamburger.setAttribute('aria-expanded','false');
        hamburger.setAttribute('aria-label','Abrir menú');
        setTimeout(()=> mobileMenu.style.display = 'none', 190);
      });
      link.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') link.click(); });
    });

    // In-page view switching
    const navLinks = document.querySelectorAll('.navcenter [data-view]');
    function showView(name){
      // hide all
      document.querySelectorAll('.view-section').forEach(s=> s.style.display = 'none');
      const el = document.getElementById('view-' + name);
      if(el) el.style.display = '';
      // update active classes
      navLinks.forEach(a=> a.classList.toggle('active', a.dataset.view === name));
      mobileLinks.forEach(m=> m.classList.toggle('active', m.dataset.view === name));
      // update hash for back/forward support
      history.replaceState(null,'', '#'+name);
      // trigger loaders for the view so mobile selection also fetches data
      try{ if(name === 'documentos' && typeof loadDocs === 'function') loadDocs(); }catch(e){}
      try{ if(name === 'inventario' && typeof loadProducts === 'function') loadProducts(); }catch(e){}
      try{ if(name === 'clientes' && typeof loadClients === 'function') loadClients(); }catch(e){}
    }

    navLinks.forEach(a=>{
      a.addEventListener('click', (e)=>{ e.preventDefault(); showView(a.dataset.view); });
      a.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') a.click(); });
    });

    mobileLinks.forEach(m => {
      m.addEventListener('click', (e)=>{
        // existing mobile close behavior
        mobileMenu.classList.remove('mobile-enter');
        mobileMenu.classList.add('mobile-leave');
        mobileMenu.setAttribute('aria-hidden','true');
        hamburger.setAttribute('aria-expanded','false');
        hamburger.setAttribute('aria-label','Abrir menú');
        setTimeout(()=> mobileMenu.style.display = 'none', 190);
        // show view
        const v = m.dataset.view;
        if(v) showView(v);
      });
    });

    // show view from hash on load
    const initialHash = location.hash.replace('#','');
    if(initialHash) showView(initialHash);

    // Modal helpers: open/close with focus restore and ESC handling
    (function(){
      let lastOpener = null;
      function focusFirst(modal){
        const focusable = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if(focusable && focusable.length) focusable[0].focus();
      }
      window.openModal = function(modal, opener){
        if(!modal) return; lastOpener = opener || document.activeElement; modal.style.display = 'flex'; modal.setAttribute('aria-hidden','false'); focusFirst(modal);
        // attach ESC handler
        modal.__esc = function(e){ if(e.key === 'Escape'){ window.closeModal(modal); } };
        document.addEventListener('keydown', modal.__esc);
      }
      window.closeModal = function(modal){
        if(!modal) return; modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); try{ document.removeEventListener('keydown', modal.__esc); }catch(e){}
        if(lastOpener && typeof lastOpener.focus === 'function') lastOpener.focus(); lastOpener = null;
      }
    })();

    // reusable confirm modal returning a Promise<boolean>
    function showConfirm(message, title='Confirmar'){
      return new Promise((resolve)=>{
        const modal = document.getElementById('confirmModal');
        const msg = document.getElementById('confirmMessage');
        const t = document.getElementById('confirmTitle');
        const ok = document.getElementById('confirmOk');
        const cancel = document.getElementById('confirmCancel');
        if(!modal || !ok || !cancel || !msg) return resolve(false);
        msg.textContent = message || '';
        if(t) t.textContent = title;
        function cleanup(){ ok.removeEventListener('click', onOk); cancel.removeEventListener('click', onCancel); window.closeModal(modal); }
        function onOk(){ cleanup(); resolve(true); }
        function onCancel(){ cleanup(); resolve(false); }
        ok.addEventListener('click', onOk);
        cancel.addEventListener('click', onCancel);
        window.openModal(modal, document.activeElement);
      });
    }

      async function loadSession(){
        const res = await fetch('/api/session');
        const data = await res.json();
        if(data.ok){
          const fullName = ((data.nombre || '') + ' ' + (data.apellido || '')).trim();
          const nameToShow = fullName || data.usuario;
          document.getElementById('welcome').textContent = `Hola, ${nameToShow} — Rol: (${data.role || 'user'})`;
          // update header avatar and role badge
          try{
            const headerAvatar = document.getElementById('headerAvatar');
            const headerRoleBadge = document.getElementById('headerRoleBadge');
            const fn = (data.nombre || '').trim();
            const ln = (data.apellido || '').trim();
            const initials = ((fn.charAt(0) || data.usuario.charAt(0) || '').toUpperCase() + (ln.charAt(0) || '').toUpperCase()).slice(0,2) || (data.usuario || '').slice(0,2).toUpperCase();
            if(headerAvatar) headerAvatar.textContent = initials;
              if(headerRoleBadge) { headerRoleBadge.textContent = data.role || 'user'; headerRoleBadge.className = 'role-badge ' + ((data.role==='admin') ? 'admin' : 'user'); }
              // compute a simple gradient based on username for avatar background
              try{
                function stringToHue(s){ let h=0; for(let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i)) % 360; } return h; }
                const hue = stringToHue(data.usuario || (data.nombre||'') + (data.apellido||''));
                const bg = `linear-gradient(135deg,hsl(${hue} 70% 40%), hsl(${(hue+60)%360} 70% 45%))`;
                if(headerAvatar) headerAvatar.style.background = bg;
                // make avatar open profile menu when clicked
                if(headerAvatar){ headerAvatar.style.cursor = 'pointer'; headerAvatar.addEventListener('click', ()=>{ profileBtn.click(); }); }
              }catch(e){}
          }catch(e){}
          // role based UI
          // expose role to client-side code
          window.currentUserRole = data.role || 'user';
          window.currentUserIsAdmin = (data.role === 'admin');
          if(data.role !== 'admin'){
            document.getElementById('createUser').style.display = 'none';
            document.getElementById('viewUsers').style.display = 'none';
            // add a class so CSS can hide admin-only controls like delete buttons
            try{ document.body.classList.add('role-user'); }catch(e){}
            // hide any delete controls that may already be in the DOM
            try{
              document.querySelectorAll('.delProd, .delClient').forEach(el => { if(el && el.style) el.style.display = 'none'; });
              const dd = document.getElementById('deleteDoc'); if(dd) dd.style.display = 'none';
            }catch(e){}
          }
        } else {
          // not logged in, redirect to home
          window.location.href = '/';
        }
      }

      document.getElementById('logout').addEventListener('click', async (e)=>{
        e.preventDefault();
        await fetch('/api/logout', { method:'POST' });
        window.location.href = '/';
      });

      // profile actions
      // Profile: Change password modal
      (function(){
        const changeLink = document.getElementById('changePwd');
        const createLink = document.getElementById('createUser');
        const viewLink = document.getElementById('viewUsers');
        // ensure modals exist: create DOM nodes if missing
        if(!document.getElementById('changePwdModal')){
          const modal = document.createElement('div'); modal.id = 'changePwdModal'; modal.role='dialog'; modal.style.display='none'; modal.style.position='fixed'; modal.style.inset='0'; modal.style.background='rgba(0,0,0,0.4)'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.padding='20px';
          modal.innerHTML = `<div style="background:var(--card);max-width:420px;width:100%;padding:18px;border-radius:10px;box-shadow:0 10px 40px rgba(2,6,23,0.2);position:relative">
            <button id="closeChangePwd" class="btn-secondary" style="position:absolute;right:10px;top:10px">Cerrar</button>
            <h3>Cambiar contraseña</h3>
            <div style="margin-top:8px"><label>Contraseña actual</label><input id="currentPassword" type="password" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" /></div>
            <div style="margin-top:8px"><label>Nueva contraseña</label><input id="newPassword" type="password" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" /></div>
            <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button id="savePassword" class="btn-primary">Guardar</button><button id="cancelChangePwd" class="btn-secondary">Cancelar</button></div>
            <div id="changePwdResult" style="margin-top:8px;color:var(--muted)"></div>
          </div>`;
          document.body.appendChild(modal);
        }

        if(!document.getElementById('createUserModal')){
          const modal = document.createElement('div'); modal.id = 'createUserModal'; modal.role='dialog'; modal.style.display='none'; modal.style.position='fixed'; modal.style.inset='0'; modal.style.background='rgba(0,0,0,0.4)'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.padding='20px';
          modal.innerHTML = `<div style="background:var(--card);max-width:520px;width:100%;padding:18px;border-radius:10px;box-shadow:0 10px 40px rgba(2,6,23,0.2);position:relative">
            <button id="closeCreateUser" class="btn-secondary" style="position:absolute;right:10px;top:10px">Cerrar</button>
            <h3>Crear usuario</h3>
            <div style="margin-top:8px;display:grid;grid-template-columns:1fr 160px;gap:8px"><div><label>Usuario</label><input id="newUserUsuario" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" /></div><div><label>Rol</label><select id="newUserRole" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px"><option value="user">user</option><option value="admin">admin</option></select></div></div>
            <div style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px"><div><label>Nombre</label><input id="newUserNombre" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" /></div><div><label>Apellido</label><input id="newUserApellido" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" /></div></div>
            <div style="margin-top:8px"><label>Teléfono</label><input id="newUserTelefono" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" /></div>
            <div style="margin-top:8px"><label>Contraseña</label><input id="newUserPassword" type="password" style="width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px" /></div>
            <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button id="saveNewUser" class="btn-primary">Crear</button><button id="cancelCreateUser" class="btn-secondary">Cancelar</button></div>
            <div id="createUserResult" style="margin-top:8px;color:var(--muted)"></div>
          </div>`;
          document.body.appendChild(modal);
        }

        if(!document.getElementById('viewUsersModal')){
          const modal = document.createElement('div'); modal.id = 'viewUsersModal'; modal.role='dialog'; modal.style.display='none'; modal.style.position='fixed'; modal.style.inset='0'; modal.style.background='rgba(0,0,0,0.4)'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.padding='20px';
          modal.innerHTML = `<div style="background:var(--card);max-width:760px;width:100%;padding:18px;border-radius:10px;box-shadow:0 10px 40px rgba(2,6,23,0.2);position:relative">
            <button id="closeViewUsers" class="btn-secondary" style="position:absolute;right:10px;top:10px">Cerrar</button>
            <h3>Usuarios</h3>
            <div id="usersList" style="margin-top:8px;max-height:420px;overflow:auto"></div>
            <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button id="refreshUsers" class="btn-ghost">Refrescar</button></div>
          </div>`;
          document.body.appendChild(modal);
        }

        // handlers
        changeLink.addEventListener('click', (e)=>{ e.preventDefault(); const m = document.getElementById('changePwdModal'); if(m) window.openModal(m, changeLink); });
        createLink.addEventListener('click', (e)=>{ e.preventDefault(); const m = document.getElementById('createUserModal'); if(m) window.openModal(m, createLink); });
        viewLink.addEventListener('click', async (e)=>{ e.preventDefault(); const m = document.getElementById('viewUsersModal'); if(m){ window.openModal(m, viewLink); loadUsersList(); } });

        // change password submit
        (function(){ const save = document.getElementById('savePassword'); if(save){ save.addEventListener('click', async ()=>{
            const cur = document.getElementById('currentPassword').value; const nw = document.getElementById('newPassword').value; const out = document.getElementById('changePwdResult'); out.textContent='';
            if(!cur || !nw) return out.textContent = 'Complete los campos';
            try{ const r = await fetch('/api/change-password', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ currentPassword: cur, newPassword: nw }) }); const j = await r.json(); if(j.ok){ out.textContent='Contraseña cambiada'; window.showToast('Contraseña actualizada','success'); window.closeModal(document.getElementById('changePwdModal')); } else out.textContent = j.error || 'Error'; }catch(err){ out.textContent = 'Error'; }
        }); }
        const cancel = document.getElementById('cancelChangePwd'); if(cancel) cancel.addEventListener('click', ()=> window.closeModal(document.getElementById('changePwdModal')));
        const closeBtn = document.getElementById('closeChangePwd'); if(closeBtn) closeBtn.addEventListener('click', ()=> window.closeModal(document.getElementById('changePwdModal')));
        })();

        // create user submit
    (function(){ const saveNew = document.getElementById('saveNewUser'); if(saveNew){ saveNew.addEventListener('click', async ()=>{
      const usuario = document.getElementById('newUserUsuario').value.trim();
      const password = document.getElementById('newUserPassword').value;
      const role = document.getElementById('newUserRole').value;
      const nombre = document.getElementById('newUserNombre').value.trim();
      const apellido = document.getElementById('newUserApellido').value.trim();
  const telefono = document.getElementById('newUserTelefono').value.trim();
      const out = document.getElementById('createUserResult'); out.textContent='';
      if(!usuario || !password) return out.textContent='Usuario y contraseña requeridos';
    try{
    // validate telefono format: (DDD)-XXXXXXX
    const phoneRaw = telefono || '';
    const phoneDigits = phoneRaw.replace(/\D/g,'');
    if(phoneDigits && !/^\d{10}$/.test(phoneDigits)){
      out.textContent = 'Teléfono debe ser 10 dígitos (ej: (412)-1234567)';
      return;
    }
    const payload = { usuario, password, role, nombre, apellido, phone: telefono };
    const r = await fetch('/api/usuarios', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }); const j = await r.json(); if(j.ok){ out.textContent='Usuario creado'; window.showToast('Usuario creado','success'); setTimeout(()=> window.closeModal(document.getElementById('createUserModal')), 600); } else out.textContent = j.error || 'Error'; }catch(err){ out.textContent = 'Error'; }
    }); }
        const cancelCreate = document.getElementById('cancelCreateUser'); if(cancelCreate) cancelCreate.addEventListener('click', ()=> window.closeModal(document.getElementById('createUserModal')));
        const closeCreate = document.getElementById('closeCreateUser'); if(closeCreate) closeCreate.addEventListener('click', ()=> window.closeModal(document.getElementById('createUserModal')));
        // phone formatting for create-user modal
        try{
          const newTel = document.getElementById('newUserTelefono');
          function formatPhoneInput(v){ const d = String(v||'').replace(/\D/g,''); if(d.length<=3) return `(${d})-`; const a=d.slice(0,3); const b=d.slice(3,10); return `(${a})-${b}`; }
          if(newTel){ newTel.addEventListener('input', (e)=>{ const v = e.target.value.replace(/\D/g,''); e.target.value = formatPhoneInput(v); }); newTel.addEventListener('blur', (e)=>{ e.target.value = formatPhoneInput(e.target.value); }); }
        }catch(e){}
        })();

        // view users list
        async function loadUsersList(){ const root = document.getElementById('usersList'); if(!root) return; root.innerHTML = 'Cargando...'; try{ const r = await fetch('/api/usuarios'); const j = await r.json(); if(j.ok && Array.isArray(j.data)){
              root.innerHTML = '';
              j.data.forEach(u => {
                    const el = document.createElement('div');
                    el.className = 'user-row';
                    el.style.justifyContent='space-between';
                    el.style.alignItems='center';
                    el.style.padding='8px';
                    el.style.borderBottom='1px solid #f1f1f1';
                    // compute initials for avatar
                    const nombre = (u.nombre || '').trim();
                    const apellido = (u.apellido || '').trim();
                    const initials = ((nombre.charAt(0) || u.usuario.charAt(0) || '').toUpperCase() + (apellido.charAt(0) || '').toUpperCase()).slice(0,2) || (u.usuario || '').slice(0,2).toUpperCase();
                    const phoneDisplay = u.phone || u.telefono || '';
                    el.innerHTML = `
                      <div style="display:flex;align-items:center;gap:12px">
                        <div class="avatar small" aria-hidden="true">${initials}</div>
                        <div class="user-meta">
                          <strong>${u.usuario}</strong>
                          <div class="user-line">${u.role}${nombre ? ' — ' + nombre : ''}${apellido ? ' ' + apellido : ''}${phoneDisplay ? ' • ' + phoneDisplay : ''}</div>
                        </div>
                      </div>
                      <div style="display:flex;gap:8px;align-items:center">
                        <div class="role-badge ${u.role === 'admin' ? 'admin' : 'user'}" style="margin-right:8px">${u.role}</div>
                        <button class="btn-ghost" data-id="${u.id}" data-usuario="${u.usuario}">Reset pwd</button>
                      </div>`;
                    root.appendChild(el);
                  });
            // attach reset handlers (admin-only)
            root.querySelectorAll('button[data-id]').forEach(b=> b.addEventListener('click', async ()=>{ const id=b.dataset.id; const usuario=b.dataset.usuario; if(!confirm(`Resetear contraseña de ${usuario}?`)) return; try{ const r = await fetch(`/api/usuarios/${id}/reset`, { method:'POST' }); const j = await r.json(); if(j.ok) window.showToast('Contraseña reseteada','success'); else window.showToast(j.error||'Error','error'); }catch(e){ window.showToast('Error','error'); } }));
        } else root.innerHTML = 'No hay usuarios'; }catch(err){ root.innerHTML = 'Error cargando'; } }
        const refresh = document.getElementById('refreshUsers'); if(refresh) refresh.addEventListener('click', loadUsersList);
        const closeView = document.getElementById('closeViewUsers'); if(closeView) closeView.addEventListener('click', ()=> window.closeModal(document.getElementById('viewUsersModal')));
      })();

      // Close dropdown when clicking outside
      document.addEventListener('click', (e)=>{
        if(!profileBtn.contains(e.target) && !profileMenu.contains(e.target)) profileMenu.style.display = 'none';
      });

      loadSession();

      // Simple toast helper injected to window for inline use
      if(!window.showToast){
        window.showToast = function(message, type='info', timeout=3000){
          let root = document.getElementById('toast-root');
          if(!root){ root = document.createElement('div'); root.id='toast-root'; root.style.position='fixed'; root.style.right='18px'; root.style.top='18px'; root.style.zIndex='9999'; document.body.appendChild(root); }
          const el = document.createElement('div'); el.className = 'toast '+type; el.textContent = message; el.style.marginTop='8px'; el.style.padding='10px 14px'; el.style.borderRadius='8px'; el.style.color='#fff'; el.style.boxShadow='0 8px 24px rgba(2,6,23,0.12)'; el.style.opacity='0'; el.style.transition='opacity 220ms, transform 220ms'; el.style.transform='translateY(-6px)';
          if(type==='success') el.style.background='#10b981'; else if(type==='error') el.style.background='#ef4444'; else if(type==='warning') el.style.background='#f59e0b'; else el.style.background='#2563eb';
          root.appendChild(el); requestAnimationFrame(()=>{ el.style.opacity='1'; el.style.transform='translateY(0)'; }); setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(-6px)'; setTimeout(()=> el.remove(),260); }, timeout);
          return el;
        }
      }

    // --- Script para crear documento: poblar clientes/productos, agregar items y enviar ---
    (function(){
      const clienteSel = document.getElementById('cliente');
      const productSearch = document.getElementById('productSearch');
      const qtyInput = document.getElementById('qty');
      const unitPriceInput = document.getElementById('unitPrice');
      const addItemBtn = document.getElementById('addItem');
      const itemsTbody = document.querySelector('#itemsTable tbody');
      const subtotalEl = document.getElementById('subtotal');
      const taxEl = document.getElementById('tax');
      const totalEl = document.getElementById('total');
      const form = document.getElementById('createDocForm');
      const tipoSel = document.getElementById('tipo');
      const currencySel = document.getElementById('currency');
  const exchangeRateInput = document.getElementById('exchangeRate');
  const bcvRateDisplay = document.getElementById('bcvRateDisplay');

  let productsCache = [];
  let lastBcvValue = null;

      // Fetch dashboard stats and populate stat cards
      async function loadDashboardStats(){
        try{
          const res = await fetch('/api/dashboard');
          const j = await res.json();
          console.debug('loadDashboardStats -> response', j);
          if(j.ok && j.data){
            document.getElementById('stat-products').textContent = j.data.productsCount || 0;
            document.getElementById('stat-clients').textContent = j.data.clientsCount || 0;
            // map new aggregate fields returned by the API
            const quotesVal = Number(j.data.totalQuotesUsd || 0);
            const notesVal = Number(j.data.totalNotesUsd || 0);
            const monthlyVal = Number(j.data.monthlySalesUsd || 0);
            const quotesCount = Number(j.data.quotesCount || 0);
            const notesCount = Number(j.data.notesCount || 0);
            const quotesEl = document.getElementById('stat-quotes');
            if(quotesEl) quotesEl.textContent = String(quotesCount);
            const quotesAmtEl = document.getElementById('stat-quotes-amount');
            if(quotesAmtEl) quotesAmtEl.textContent = (quotesVal || 0).toFixed(2) + ' USD';
            const notesEl = document.getElementById('stat-notes');
            if(notesEl) notesEl.textContent = String(notesCount);
            const notesAmtEl = document.getElementById('stat-notes-amount');
            if(notesAmtEl) notesAmtEl.textContent = (notesVal || 0).toFixed(2) + ' USD';
            const salesEl = document.getElementById('stat-sales');
            if(salesEl) salesEl.textContent = monthlyVal.toFixed(2);
            // update advanced stats after basic stats are set
            try{ if(typeof loadAdvancedStats === 'function') loadAdvancedStats(); }catch(e){ console.error('Failed to load advanced stats', e); }
          } else {
            console.warn('dashboard API error', j);
            // show visible placeholders so cards don't look empty
            try{ document.getElementById('stat-products').textContent = '—'; }catch(e){}
            try{ document.getElementById('stat-clients').textContent = '—'; }catch(e){}
            try{ document.getElementById('stat-quotes').textContent = '—'; }catch(e){}
            try{ document.getElementById('stat-notes').textContent = '—'; }catch(e){}
            try{ document.getElementById('stat-sales').textContent = '—'; }catch(e){}
          }
        }catch(err){ console.error('Error loading dashboard stats', err); }
      }
      loadDashboardStats();
      // Auto-refresh every 30s, but pause when page is hidden to save resources
      const DASH_REFRESH_MS = 30000;
      let dashRefreshHandle = null;
      function startDashAutoRefresh(){
        if(dashRefreshHandle) clearInterval(dashRefreshHandle);
        dashRefreshHandle = setInterval(loadDashboardStats, DASH_REFRESH_MS);
      }
      function stopDashAutoRefresh(){ if(dashRefreshHandle){ clearInterval(dashRefreshHandle); dashRefreshHandle = null; } }
      document.addEventListener('visibilitychange', ()=>{
        if(document.hidden) stopDashAutoRefresh(); else { loadDashboardStats(); startDashAutoRefresh(); }
      });
      startDashAutoRefresh();

      // --- Estadísticas avanzadas ---
      async function loadAdvancedStats(){
        try{
          const res = await fetch('/api/dashboard');
          const j = await res.json();
          if(!(j.ok && j.data)) return;
          const d = j.data;
          // total ventas (ND)
          const totalVentas = Number(d.totalVentasUsd || 0).toFixed(2);
          const totalVentasEl = document.getElementById('adv-total-ventas');
          if(totalVentasEl) totalVentasEl.textContent = `${totalVentas} USD`;

          // monthly totals: render simple bars
          const monthlyEl = document.getElementById('adv-monthly');
          if(monthlyEl && Array.isArray(d.monthlyTotals)){
            monthlyEl.innerHTML = '';
            const maxVal = Math.max(1, ...d.monthlyTotals.map(m=> Number(m.total_usd || 0)));
            d.monthlyTotals.forEach(m => {
              const val = Number(m.total_usd || 0);
              const bar = document.createElement('div');
              bar.style.display = 'flex';
              bar.style.flexDirection = 'column';
              bar.style.alignItems = 'center';
              bar.style.width = '48px';
              const heightPct = Math.round((val / maxVal) * 100);
              const inner = document.createElement('div');
              inner.style.width = '100%';
              inner.style.height = Math.max(6, Math.round(heightPct * 0.8)) + 'px';
              inner.style.background = '#10b981';
              inner.style.borderRadius = '4px';
              inner.title = `${m.year}-${String(m.month).padStart(2,'0')}: ${val.toFixed(2)} USD`;
              const lbl = document.createElement('div'); lbl.style.fontSize='11px'; lbl.style.marginTop='6px'; lbl.style.textAlign='center'; lbl.textContent = `${String(m.month).padStart(2,'0')}/${String(m.year).slice(-2)}`;
              monthlyEl.appendChild(bar);
              bar.appendChild(inner);
              bar.appendChild(lbl);
            });
          }

          // top buyers
          const buyersEl = document.getElementById('adv-top-buyers');
          if(buyersEl){
            buyersEl.innerHTML = '';
            if(Array.isArray(d.topBuyersThisMonth) && d.topBuyersThisMonth.length){
              d.topBuyersThisMonth.forEach(b => {
                const row = document.createElement('div');
                row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0'; row.style.borderBottom='1px solid #f1f1f1';
                const left = document.createElement('div'); left.style.fontSize='13px'; left.textContent = b.client_name || (b.client_rif || 'Sin cliente');
                const right = document.createElement('div'); right.style.fontSize='13px'; right.style.fontWeight='700'; right.textContent = (Number(b.total_usd)||0).toFixed(2) + ' USD';
                row.appendChild(left); row.appendChild(right);
                buyersEl.appendChild(row);
              });
            } else {
              buyersEl.innerHTML = '<div style="color:var(--muted)">No hay compras en el mes.</div>';
            }
          }
        }catch(err){ console.error('Error cargando estadísticas avanzadas', err); }
      }
      // cargar junto al dashboard
      loadAdvancedStats();

      async function fetchClients(){
        try{
          const r = await fetch('/api/clientes');
          const j = await r.json();
          clienteSel.innerHTML = '';
          if(j.ok && Array.isArray(j.data)){
            clienteSel.appendChild(new Option('-- Seleccione --',''));
            j.data.forEach(c => clienteSel.appendChild(new Option(c.name, c.id)));
          } else {
            clienteSel.appendChild(new Option('Error cargando clientes',''));
          }
        }catch(err){
          clienteSel.innerHTML = '';
          clienteSel.appendChild(new Option('Error conectando',''));
        }
      }

      async function fetchProducts(){
        try{
          const r = await fetch('/api/productos');
          const j = await r.json();
          productsCache = j.ok ? j.data : [];
        }catch(e){ productsCache = []; }
      }

      // Debounce helper
      function debounce(fn, wait=250){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }

      // Disable exchange rate input when currency is USD
      async function fetchAndSetBcv(){
        try{
          const r = await fetch('/api/bcv');
          const j = await r.json();
          if(j.ok && j.price){
            exchangeRateInput.value = String(j.price);
            lastBcvValue = Number(j.price);
            exchangeRateInput.disabled = true;
            if(bcvRateDisplay) bcvRateDisplay.textContent = `BCV: ${exchangeRateInput.value}`;
            recalc(); refreshRows();
            return true;
          }
        }catch(err){ }
        return false;
      }

      function updateExchangeRateState(){
        const cur = (currencySel.value||'').toUpperCase();
        if(cur === 'USD'){
          exchangeRateInput.value = '1.0';
          exchangeRateInput.disabled = true;
          if(bcvRateDisplay) bcvRateDisplay.textContent = '';
        } else {
          exchangeRateInput.disabled = false;
          // if VES, try to auto-fill from BCV proxy
          if(cur === 'VES'){
            // automatically fetch and set BCV rate
            fetchAndSetBcv();
          }
        }
        // update BCV display
        if(bcvRateDisplay){
          if(currencySel.value === 'VES' && lastBcvValue != null){
            bcvRateDisplay.textContent = `BCV: ${String(lastBcvValue)}`;
            exchangeRateInput.disabled = true;
          } else {
            bcvRateDisplay.textContent = '';
            if(currencySel.value !== 'USD') exchangeRateInput.disabled = false;
          }
        }
      }
      currencySel.addEventListener('change', updateExchangeRateState);
      // no checkbox: BCV rate is fetched automatically when currency is VES
      // init state
      updateExchangeRateState();
  // ensure totals update when currency or tipo change
  currencySel.addEventListener('change', ()=>{ recalc(); refreshRows(); });
  tipoSel.addEventListener('change', ()=>{ recalc(); });

      const resultsRoot = document.getElementById('productResults');
      function renderProductResults(list){
        resultsRoot.innerHTML = '';
        if(!list || list.length === 0){ resultsRoot.style.display = 'none'; return; }
        list.forEach((p, idx) => {
          const el = document.createElement('div');
          el.setAttribute('role','option');
          el.className = 'product-result';
          el.style.padding = '8px';
          el.style.borderRadius = '6px';
          el.style.cursor = 'pointer';
          el.dataset.idx = idx;
          el.dataset.id = p.id;
          el.innerHTML = `<div style="font-weight:600">${p.product_code} — ${p.description}</div><div style="font-size:12px;color:var(--muted)">Precio USD: ${Number(p.price_usd).toFixed(2)}</div>`;
          el.addEventListener('click', ()=> selectProductFromResult(p));
          resultsRoot.appendChild(el);
        });
        resultsRoot.style.display = 'block';
      }

      function findProductsQuery(q){
        const s = String(q||'').toLowerCase().trim();
        if(!s) return [];
        return productsCache.filter(p => p.product_code.toLowerCase().includes(s) || p.description.toLowerCase().includes(s)).slice(0,8);
      }

      function selectProductFromResult(p){
        // fill productSearch with code - description, set selection data, prefill unit price
        productSearch.value = `${p.product_code} - ${p.description}`;
        productSearch.dataset.selectedId = p.id;
        unitPriceInput.value = Number(p.price_usd).toFixed(4);
        resultsRoot.style.display = 'none';
        qtyInput.focus();
      }

      const onProductInput = debounce(async function(e){
        const q = productSearch.value.trim();
        if(!q){ resultsRoot.style.display = 'none'; productSearch.dataset.selectedId = ''; return; }
        // ensure cache
        if(productsCache.length === 0) await fetchProducts();
        const list = findProductsQuery(q);
        renderProductResults(list);
      }, 200);

      productSearch.addEventListener('input', onProductInput);
      productSearch.addEventListener('keydown', (e)=>{
        const visible = resultsRoot.style.display === 'block';
        if(!visible) return;
        const items = Array.from(resultsRoot.children);
        const active = resultsRoot.querySelector('.active');
        let idx = active ? items.indexOf(active) : -1;
        if(e.key === 'ArrowDown'){
          e.preventDefault(); idx = Math.min(items.length-1, idx+1); items.forEach(it=>it.classList.remove('active')); if(items[idx]) items[idx].classList.add('active');
        } else if(e.key === 'ArrowUp'){
          e.preventDefault(); idx = Math.max(0, idx-1); items.forEach(it=>it.classList.remove('active')); if(items[idx]) items[idx].classList.add('active');
        } else if(e.key === 'Enter'){
          e.preventDefault(); if(items[idx]){
            const id = items[idx].dataset.id; const p = productsCache.find(x=>String(x.id)===String(id)); if(p) selectProductFromResult(p);
          }
        } else if(e.key === 'Escape'){
          resultsRoot.style.display = 'none';
        }
      });

      // click outside closes results
      document.addEventListener('click', (ev)=>{ if(!ev.target.closest('#productResults') && ev.target !== productSearch) resultsRoot.style.display = 'none'; });

      function findProduct(query){
        const q = String(query||'').toLowerCase();
        return productsCache.find(p => p.product_code.toLowerCase() === q || p.description.toLowerCase().includes(q));
      }

      function recalc(){
        let subtotal = 0;
        itemsTbody.querySelectorAll('tr').forEach(tr => {
          const total = parseFloat(tr.dataset.lineTotal || '0');
          subtotal += total;
        });
        const currency = (currencySel.value||'').toUpperCase();
        let tax = 0;
        if(currency === 'USD'){
          // no IVA when payment is in USD
          tax = 0;
        } else {
          tax = +(subtotal * 0.16).toFixed(2);
        }
  const total = +(subtotal + tax).toFixed(2);
  subtotalEl.textContent = subtotal.toFixed(2);
  taxEl.textContent = tax.toFixed(2);
  totalEl.textContent = total.toFixed(2);
  // BSF equivalents
  const ex = Number(exchangeRateInput.value) || 1.0;
  const subtotalBsfEl = document.getElementById('subtotalBsf');
  const taxBsfEl = document.getElementById('taxBsf');
  const totalBsfEl = document.getElementById('totalBsf');
  if(subtotalBsfEl){ subtotalBsfEl.textContent = (subtotal * ex).toFixed(2); }
  if(taxBsfEl){ taxBsfEl.textContent = (tax * ex).toFixed(2); }
  if(totalBsfEl){ totalBsfEl.textContent = (total * ex).toFixed(2); }
        // show IVA note on quotes/notes when currency is USD
        const ivaNoteEl = document.getElementById('ivaNote');
        const usdTotals = document.getElementById('usdTotals');
        const bsfTotals = document.getElementById('bsfTotals');
        if(usdTotals && bsfTotals){
          if(currency === 'USD'){
            usdTotals.style.display = 'block';
            bsfTotals.style.display = 'none';
          } else {
            usdTotals.style.display = 'none';
            bsfTotals.style.display = 'block';
          }
        }
        if(ivaNoteEl){
          if(currency === 'USD' && tipoSel.value === 'CT'){
            ivaNoteEl.style.display = 'block';
          } else {
            ivaNoteEl.style.display = 'none';
          }
        }
        // update items table headers to reflect currency
        const unitHeader = document.querySelector('#itemsTable thead th:nth-child(3)');
        const totalHeader = document.querySelector('#itemsTable thead th:nth-child(5)');
        if(unitHeader) unitHeader.textContent = currency === 'USD' ? 'P.Unit (USD)' : 'P.Unit (Bs.F)';
        if(totalHeader) totalHeader.textContent = currency === 'USD' ? 'Total (USD)' : 'Total (Bs.F)';
      }

      function createRow(item){
        const tr = document.createElement('tr');
        // store USD values for later conversions
        tr.dataset.unitUsd = Number(item.unit_price_usd).toFixed(4);
        tr.dataset.qty = Number(item.quantity);
        tr.dataset.totalUsd = Number(item.total).toFixed(2);
        tr.dataset.lineTotal = item.total.toFixed(2);
        const currency = (currencySel.value||'').toUpperCase();
        const ex = Number(exchangeRateInput.value) || 1.0;
        let unitDisplay = tr.dataset.unitUsd;
        let totalDisplay = tr.dataset.totalUsd;
        if(currency !== 'USD'){
          unitDisplay = (Number(tr.dataset.unitUsd) * ex).toFixed(2);
          totalDisplay = (Number(tr.dataset.totalUsd) * ex).toFixed(2);
        }
    tr.innerHTML = `<td>${item.description || ''}</td><td>${item.quantity}</td><td>${unitDisplay}</td><td>${Number(item.discount||0).toFixed(2)}</td><td>${totalDisplay}</td><td><button type="button" class="removeItem btn-danger">Eliminar</button></td>`;
  tr.querySelector('.removeItem').addEventListener('click', ()=>{ tr.remove(); recalc(); refreshRows(); });
        itemsTbody.appendChild(tr);
      }

      function refreshRows(){
        const currency = (currencySel.value||'').toUpperCase();
        const ex = Number(exchangeRateInput.value) || 1.0;
        Array.from(itemsTbody.querySelectorAll('tr')).forEach(tr => {
          const unitUsd = Number(tr.dataset.unitUsd || '0');
          const qty = Number(tr.dataset.qty || '0');
          const totalUsd = Number(tr.dataset.totalUsd || '0');
          const unitDisplay = currency === 'USD' ? unitUsd.toFixed(4) : (unitUsd * ex).toFixed(2);
          const totalDisplay = currency === 'USD' ? totalUsd.toFixed(2) : (totalUsd * ex).toFixed(2);
          // update cells: unit is 3rd cell (index 2), total is 5th cell (index 4)
          const cols = tr.children;
          if(cols[2]) cols[2].textContent = unitDisplay;
          if(cols[4]) cols[4].textContent = totalDisplay;
        });
      }

  addItemBtn.addEventListener('click', ()=>{
    // enforce integer quantities
    const q = parseInt(qtyInput.value || '0', 10);
    const qtyInt = Math.max(1, isNaN(q) ? 0 : q);
    const up = parseFloat(unitPriceInput.value || '0');
  if(qtyInt <= 0 || up <= 0) return (window.showToast || (()=>alert('Cantidad y precio deben ser mayores que cero')))('Cantidad y precio deben ser mayores que cero','error');
    const selectedId = productSearch.dataset.selectedId;
    let found = null;
    if(selectedId){ found = productsCache.find(p => String(p.id) === String(selectedId)); }
    if(!found) found = findProduct(productSearch.value.trim());
    const desc = found ? `${found.product_code} - ${found.description}` : productSearch.value.trim();
    const total = +(qtyInt * up).toFixed(2);
    const item = { product_id: found ? found.id : null, description: desc, quantity: qtyInt, unit_price_usd: up, discount: 0, total };
  createRow(item);
  recalc();
  refreshRows();
    // clear product fields and selection
    productSearch.value = '';
    productSearch.dataset.selectedId = '';
    qtyInput.value = '1';
    unitPriceInput.value = '0.00';
  });

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const items = [];
        itemsTbody.querySelectorAll('tr').forEach(tr => {
          const cols = tr.children;
          const description = cols[0].textContent.trim();
          const quantity = parseInt(cols[1].textContent.trim(), 10) || 0;
          // read unit price in USD from data attribute to avoid reading Bs.F displayed value
          const unit_price_usd = parseFloat(tr.dataset.unitUsd || cols[2].textContent.trim());
          const discount = parseFloat(cols[3].textContent.trim()) || 0;
          const total = parseFloat(cols[4].textContent.trim()) || 0;
          items.push({ product_id: null, description, quantity, unit_price_usd, discount });
        });
  if(items.length === 0) return (window.showToast || (()=>alert('Agregue al menos un item')))('Agregue al menos un item','warning');

        const payload = {
          tipo: tipoSel.value || 'CT',
          cliente_id: clienteSel.value || null,
          currency: currencySel.value || 'USD',
          exchange_rate: parseFloat(exchangeRateInput.value) || 1.0,
          bcv_rate: (currencySel.value === 'VES') ? (lastBcvValue != null ? lastBcvValue : parseFloat(exchangeRateInput.value) || null) : null,
          items
        };

        try{
          const res = await fetch('/api/documentos', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
          const j = await res.json();
          if(j.ok){
            (window.showToast || (()=>alert()))(`Documento guardado: ${j.doc_number}`,'success');
            // limpiar formulario
            itemsTbody.innerHTML = '';
            recalc();
            showView('documentos');
          } else {
            (window.showToast || (()=>alert()))(`Error: ${j.error || 'Error al guardar'}`,'error');
          }
        }catch(err){
          document.getElementById('createResult').textContent = `Error: ${err.message}`;
        }
      });

      // Initialize caches
      fetchClients();
      fetchProducts();
    })();

    // --- Inventario: list, create, edit, delete ---
    (function(){
      const productsGrid = document.getElementById('productsGrid');
      const addBtn = document.getElementById('addProduct');
  const newDesc = document.getElementById('newDesc');
  const newPrice = document.getElementById('newPrice');
  const newStock = document.getElementById('newStock');
  const generatedCode = document.getElementById('generatedCode');

      async function loadProducts(){
        try{
          if(generatedCode) generatedCode.value = '';
          const r = await fetch('/api/productos');
          const j = await r.json();
          productsGrid.innerHTML = '';
          if(j.ok && Array.isArray(j.data)){
            const cards = await import('../lib/cards.mjs');
            j.data.forEach(p => {
              const card = document.createElement('div');
              card.className = 'product-card';
              card.setAttribute('role', 'article');
              card.tabIndex = 0;
              card.style.background = 'var(--surface)';
              card.style.padding = '12px';
              card.style.borderRadius = '10px';
              card.style.boxShadow = '0 6px 18px rgba(2,6,23,0.04)';
              card.innerHTML = cards.productCard(p);
              // remove delete button for non-admins
              if(!window.currentUserIsAdmin){ const del = card.querySelector('.delProd'); if(del) del.remove(); }
              productsGrid.appendChild(card);
            });
            // attach delete handlers only for admins
            if(window.currentUserIsAdmin){
              productsGrid.querySelectorAll('.delProd').forEach(b=> b.addEventListener('click', async ()=>{
                const id=b.dataset.id;
                if(!(await showConfirm('Eliminar producto?'))) return;
                try{ const r = await fetch(`/api/productos/${id}`, { method:'DELETE' }); const j=await r.json(); if(j.ok){ window.showToast('Producto eliminado','success'); loadProducts(); } else window.showToast('Error al eliminar','error'); }catch(e){ window.showToast('Error al eliminar','error'); }
              }));
            }
            // modal handlers (save/cancel)
            const productModal = document.getElementById('productModal');
            const closeProductModal = document.getElementById('closeProductModal');
            const cancelProdModal = document.getElementById('cancelProdModal');
            const saveProdModal = document.getElementById('saveProdModal');
            if(closeProductModal) closeProductModal.addEventListener('click', ()=>{ window.closeModal(productModal); });
            if(cancelProdModal) cancelProdModal.addEventListener('click', ()=>{ window.closeModal(productModal); });
            if(saveProdModal) saveProdModal.addEventListener('click', async ()=>{
              const id = document.getElementById('editProdId').value;
              const desc = document.getElementById('editProdDesc').value.trim();
              const price = parseFloat(document.getElementById('editProdPrice').value) || 0;
              try{
                const r = await fetch(`/api/productos/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ description: desc, price_usd: price }) });
                const j = await r.json();
                if(j.ok){ window.showToast('Producto actualizado','success'); window.closeModal(productModal); loadProducts(); }
                else window.showToast('Error al actualizar','error');
              }catch(e){ window.showToast('Error al actualizar','error'); }
            });
            // edit handler opens modal
            productsGrid.querySelectorAll('.editProd').forEach(b=> b.addEventListener('click', (e)=>{
              const id = b.dataset.id;
              const code = b.dataset.code;
              const desc = b.dataset.desc;
              const price = b.dataset.price;
              // fill modal fields
              const modal = document.getElementById('productModal');
              const editId = document.getElementById('editProdId');
              const editCode = document.getElementById('editProdCode');
              const editDesc = document.getElementById('editProdDesc');
              const editPrice = document.getElementById('editProdPrice');
              editId.value = id;
              editCode.value = code;
              editDesc.value = desc;
              editPrice.value = price;
              window.openModal(modal, b);
            }));
          } else {
            productsGrid.innerHTML = '<div style="color:var(--muted)">No hay productos</div>';
          }
        }catch(err){ productsGrid.innerHTML = '<div style="color:var(--muted)">Error al cargar productos</div>'; }
      }

      addBtn.addEventListener('click', async ()=>{
        // limpiar el campo antes de crear para evitar valores antiguos
        if(generatedCode) generatedCode.value = '';
        const payload = { description: newDesc.value.trim(), price_usd: parseFloat(newPrice.value)||0 };
        if(!payload.description) return window.showToast('Descripción requerida','warning');
        try{
          const r = await fetch('/api/productos', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
          const j = await r.json();
          if(j.ok){ newDesc.value=''; newPrice.value='0.00'; if(generatedCode) generatedCode.value = j.product_code || ''; window.showToast(`Producto creado: ${j.product_code}`,'success');
            // dejar el código visible unos segundos y luego limpiar
            setTimeout(()=>{ if(generatedCode) generatedCode.value = ''; }, 5000);
            loadProducts(); }
          else window.showToast('Error: ' + (j.error||''),'error');
        }catch(err){ window.showToast('Error al crear producto','error'); }
      });

      // load when entering view
      navLinks.forEach(a=>{ if(a.dataset.view === 'inventario') a.addEventListener('click', ()=> setTimeout(loadProducts, 150)); });
      if(location.hash.replace('#','') === 'inventario') loadProducts();
      // expose for mobile menu and global calls
      try{ window.loadProducts = loadProducts; }catch(e){}
    })();

    // --- Clientes CRUD ---
    (function(){
      const clientsGrid = document.getElementById('clientsGrid');
      const addClientBtn = document.getElementById('addClient');
      const clientName = document.getElementById('clientName');
      const clientRifType = document.getElementById('clientRifType');
      const clientRifNumber = document.getElementById('clientRifNumber');
      const clientPhone = document.getElementById('clientPhone');
      const clientAddress = document.getElementById('clientAddress');

      // phone formatting: (412)-7307933 -> (ddd)-xxxxxxx
      function formatPhoneRaw(v){
        const digits = String(v||'').replace(/\D/g,'');
        if(digits.length <= 3) return `(${digits})-`;
        const d = digits.slice(0,3);
        const rest = digits.slice(3,10);
        return `(${d})-${rest}`;
      }
      clientPhone.addEventListener('input', (e)=>{ const d = e.target.value.replace(/\D/g,''); e.target.value = formatPhoneRaw(d); });
      clientPhone.addEventListener('blur', (e)=>{ e.target.value = formatPhoneRaw(e.target.value); });

      async function loadClients(){
        try{
          const r = await fetch('/api/clientes');
          const j = await r.json();
          clientsGrid.innerHTML = '';
          if(j.ok && Array.isArray(j.data)){
            const cards = await import('../lib/cards.mjs');
            j.data.forEach(c => {
              // ensure edit button carries necessary data for the modal
              const item = Object.assign({}, c);
              const card = document.createElement('div');
              card.className = 'client-card';
              card.setAttribute('role', 'article');
              card.tabIndex = 0;
              card.style.background = 'var(--surface)';
              card.style.padding = '12px';
              card.style.borderRadius = '10px';
              card.style.boxShadow = '0 6px 18px rgba(2,6,23,0.04)';
              card.innerHTML = cards.clientCard(c);
              // remove delete button for non-admins
              if(!window.currentUserIsAdmin){ const del = card.querySelector('.delClient'); if(del) del.remove(); }
              // set data attributes on the edit button so the handler can read them
              const editBtn = card.querySelector('.editClient');
              if(editBtn){ editBtn.dataset.name = c.name || ''; editBtn.dataset.rif = c.rif_ci || ''; editBtn.dataset.phone = c.phone || ''; editBtn.dataset.address = c.address || ''; }
              clientsGrid.appendChild(card);
            });
            if(window.currentUserIsAdmin){
              clientsGrid.querySelectorAll('.delClient').forEach(b=> b.addEventListener('click', async ()=>{
                const id = b.dataset.id;
                if(!(await showConfirm('Eliminar cliente?'))) return;
                try{ const r = await fetch(`/api/clientes/${id}`, { method:'DELETE' }); const j = await r.json(); if(j.ok){ window.showToast('Cliente eliminado','success'); loadClients(); } else window.showToast('Error al eliminar','error'); }catch(e){ window.showToast('Error al eliminar','error'); }
              }));
            }
            // edit via modal: attach handlers that open the client modal
            clientsGrid.querySelectorAll('.editClient').forEach(b=> b.addEventListener('click', ()=>{
              const id = b.dataset.id;
              // prepare modal elements
              const modal = document.getElementById('clientModal');
              const editId = document.getElementById('editClientId');
              const editName = document.getElementById('editClientName');
              const editRifType = document.getElementById('editClientRifType');
              const editRifNumber = document.getElementById('editClientRifNumber');
              const editPhone = document.getElementById('editClientPhone');
              const editAddr = document.getElementById('editClientAddress');
              // read data from button dataset populated when rendering
              const name = b.dataset.name || '';
              const rifFull = b.dataset.rif || '';
              const phone = b.dataset.phone || '';
              const addr = b.dataset.address || '';
              // split rifFull
              let rtype = '';
              let rnum = rifFull;
              const m = rifFull.match(/^\s*([VEJG])\-?\s*(\d+)$/i);
              if(m){ rtype = m[1].toUpperCase(); rnum = m[2]; }
              editId.value = id;
              editName.value = name;
              editRifType.value = rtype || 'V';
              editRifNumber.value = rnum || '';
              editPhone.value = phone || '';
              editAddr.value = addr || '';
              window.openModal(modal, b);
            }));
            // ensure modal handlers are attached once
            (function(){
              const modal = document.getElementById('clientModal');
              if(!modal) return;
              const closeBtn = document.getElementById('closeClientModal');
              const cancelBtn = document.getElementById('cancelClientModal');
              const saveBtn = document.getElementById('saveClientModal');
              if(closeBtn) closeBtn.addEventListener('click', ()=>{ window.closeModal(modal); });
              if(cancelBtn) cancelBtn.addEventListener('click', ()=>{ window.closeModal(modal); });
              if(saveBtn) saveBtn.addEventListener('click', async ()=>{
                const id = document.getElementById('editClientId').value;
                const name = document.getElementById('editClientName').value.trim();
                const rt = document.getElementById('editClientRifType').value;
                const rn = document.getElementById('editClientRifNumber').value.trim();
                const rif_ci = (rt && rn) ? `${rt}-${rn}` : rn;
                const phone = document.getElementById('editClientPhone').value.trim();
                const addr = document.getElementById('editClientAddress').value.trim();
                if(!name) return window.showToast('Nombre requerido','warning');
                if(!/^\(\d{3}\)-\d{7}$/.test(phone)) return window.showToast('Teléfono debe ser formato (DDD)-XXXXXXX','warning');
                try{
                  const r = await fetch(`/api/clientes/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ name, rif_ci, phone, address: addr }) });
                  const j = await r.json();
                  if(j.ok){ window.showToast('Cliente actualizado','success'); window.closeModal(modal); loadClients(); }
                  else window.showToast('Error al actualizar','error');
                }catch(e){ window.showToast('Error al actualizar','error'); }
              });
              // attach phone formatter to modal phone input
              try{
                const editPhoneInput = document.getElementById('editClientPhone');
                if(editPhoneInput){
                  editPhoneInput.addEventListener('input', (e)=>{ const d = e.target.value.replace(/\D/g,''); e.target.value = formatPhoneRaw(d); });
                  editPhoneInput.addEventListener('blur', (e)=>{ e.target.value = formatPhoneRaw(e.target.value); });
                }
              }catch(e){}
            })();
          } else {
            clientsTbody.innerHTML = '<tr><td colspan="6">No hay clientes</td></tr>';
          }
        }catch(err){ clientsTbody.innerHTML = '<tr><td colspan="6">Error al cargar clientes</td></tr>'; }
      }

      addClientBtn.addEventListener('click', async ()=>{
        const nameVal = clientName.value.trim();
        const rifVal = (clientRifType.value && clientRifNumber.value) ? `${clientRifType.value}-${clientRifNumber.value.trim()}` : clientRifNumber.value.trim();
        const phoneVal = clientPhone.value.trim();
        const addressVal = clientAddress.value.trim();
        if(!nameVal) return alert('Nombre requerido');
        if(!/^\(\d{3}\)-\d{7}$/.test(phoneVal)) return alert('Teléfono debe tener formato (DDD)-XXXXXXX');
        const payload = { name: nameVal, rif_ci: rifVal, phone: phoneVal, address: addressVal };
        try{
          const r = await fetch('/api/clientes', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
          const j = await r.json();
          if(j.ok){ clientName.value=''; clientRifNumber.value=''; clientPhone.value=''; clientAddress.value=''; loadClients(); }
          else alert('Error: ' + (j.error||''));
        }catch(err){ alert('Error al crear cliente'); }
      });

      // populate when entering view
      navLinks.forEach(a=>{ if(a.dataset.view === 'clientes') a.addEventListener('click', ()=> setTimeout(loadClients, 150)); });
      if(location.hash.replace('#','') === 'clientes') loadClients();
      try{ window.loadClients = loadClients; }catch(e){}
    })();

    // --- Documentos list & detail handling ---
    (function(){
      const docsGrid = document.querySelector('#docsGrid');
      const docModal = document.getElementById('docModal');
      const modalBody = document.getElementById('modalBody');
      const modalDocNumber = document.getElementById('modalDocNumber');
      const closeDocModal = document.getElementById('closeDocModal');
      const deleteDocBtn = document.getElementById('deleteDoc');
      let currentDocId = null;

      async function loadDocs(){
        try{
          const r = await fetch('/api/documentos');
          const j = await r.json();
          docsGrid.innerHTML = '';
          if(j.ok && Array.isArray(j.data)){
            const cards = await import('../lib/cards.mjs');
            j.data.forEach(d => {
              const card = document.createElement('div');
              card.className = 'doc-card';
              card.setAttribute('role', 'article');
              card.tabIndex = 0;
              card.style.background = 'var(--surface)';
              card.style.padding = '14px';
              card.style.borderRadius = '10px';
              card.style.boxShadow = '0 6px 18px rgba(2,6,23,0.06)';
              card.style.display = 'flex';
              card.style.flexDirection = 'column';
              card.style.gap = '8px';
              card.style.minHeight = '120px';
              card.innerHTML = cards.docCard(d);
              docsGrid.appendChild(card);
            });
            // attach tooltip handlers to BCV badges
            (function(){
              // create tooltip root if missing
              let tt = document.getElementById('bcv-tooltip');
              if(!tt){
                tt = document.createElement('div'); tt.id = 'bcv-tooltip';
                tt.style.position = 'fixed'; tt.style.zIndex = '99999'; tt.style.pointerEvents = 'none'; tt.style.padding = '8px 10px'; tt.style.background = 'rgba(2,6,23,0.9)'; tt.style.color = '#fff'; tt.style.borderRadius = '6px'; tt.style.fontSize = '13px'; tt.style.boxShadow = '0 6px 20px rgba(2,6,23,0.4)'; tt.style.transition = 'opacity 160ms, transform 160ms'; tt.style.opacity = '0'; tt.style.transform = 'translateY(-6px)'; tt.style.display = 'none'; document.body.appendChild(tt);
              }
              const badges = docsGrid.querySelectorAll('.bcv-badge');
              badges.forEach(b => {
                b.addEventListener('mouseenter', (e)=>{
                  const rate = b.dataset.bcvRate; const date = b.dataset.bcvDate;
                  const d = date ? new Date(date) : null;
                  const txt = `Tasa BCV: ${Number(rate).toFixed(6)}${d? ' — ' + d.toLocaleString(): ''}`;
                  tt.textContent = txt;
                  tt.style.display = 'block'; tt.style.opacity = '1'; tt.style.transform = 'translateY(0)';
                  const rect = b.getBoundingClientRect();
                  // position above the badge, center aligned
                  const left = Math.min(window.innerWidth - 16 - tt.offsetWidth, Math.max(8, rect.left + (rect.width/2) - (tt.offsetWidth/2)));
                  const top = Math.max(8, rect.top - tt.offsetHeight - 8);
                  tt.style.left = left + 'px'; tt.style.top = top + 'px';
                });
                b.addEventListener('mouseleave', ()=>{
                  tt.style.opacity = '0'; tt.style.transform = 'translateY(-6px)'; setTimeout(()=>{ tt.style.display = 'none'; }, 180);
                });
              });
            })();
            // attach handlers
            docsGrid.querySelectorAll('.viewDoc').forEach(b => b.addEventListener('click', ()=> openDoc(b.dataset.id)));
          } else {
            docsGrid.innerHTML = '<div style="color:var(--muted)">No hay documentos.</div>';
          }
        }catch(err){
          docsGrid.innerHTML = '<div style="color:var(--muted)">Error cargando documentos</div>';
        }
      }

      async function openDoc(id){
        try{
          console.log('openDoc', id);
          // ensure modal shows a loading state immediately so user sees feedback
          currentDocId = id;
          modalDocNumber.textContent = `Cargando...`;
          modalBody.innerHTML = `<div style="padding:12px">Cargando documento...</div>`;
          window.openModal(docModal, null);

          const r = await fetch(`/api/documentos/${id}`);
          const j = await r.json();
          if(j.ok){
            modalDocNumber.textContent = j.data.doc_number || `Documento ${id}`;
            // Build a printable 'Nota de Entrega' HTML similar to the reference image
            const currency = (j.data.currency||'USD').toUpperCase();
            const rate = j.data.bcv_rate ? Number(j.data.bcv_rate) : (j.data.exchange_rate ? Number(j.data.exchange_rate) : null);
            function fmt(n, decimals=2){ return Number(n||0).toFixed(decimals); }
            let itemsHtml = '';
            j.data.items.forEach(it => {
              // normalize possible field names
              let code = (it.product_code || it.codigo || it.code || '').toString().trim();
              let desc = (it.description || it.nombre || it.desc || '').toString().trim();
              // If no explicit code, try to extract one from the start of the description
              if(!code && desc){
                // common patterns: "P-000004 - BRAGA", "P000004: BRAGA", "P000004/ BRAGA"
                const m = desc.match(/^\s*([A-Za-z0-9\-_.]+)\s*[-:\/]+\s*(.*)$/);
                if(m){ code = m[1].trim(); desc = (m[2] || '').trim(); }
              }
              // If code exists and description still contains the code at the start, remove it (safety)
              if(code && desc){
                const esc = code.replace(/[.*+?^${}()|[\\]\/\\]/g,'\\$&');
                const pattern = new RegExp('^\\s*' + esc + "\\s*[-:\\/]?\\s*", 'i');
                desc = desc.replace(pattern, '').trim();
              }
              if(currency === 'USD' && !j.data.bcv_rate){
                itemsHtml += `<tr><td style="border:1px solid #000;padding:6px">${code}</td><td style="border:1px solid #000;padding:6px">${desc}</td><td style="border:1px solid #000;padding:6px;text-align:center">${fmt(it.quantity,2)}</td><td style="border:1px solid #000;padding:6px;text-align:right">$ ${fmt(it.unit_price_usd,2)}</td><td style="border:1px solid #000;padding:6px;text-align:right">$ ${fmt(it.total_usd,2)}</td></tr>`;
              } else if(j.data.bcv_rate){
                const unit = Number(it.unit_price_bsf || (it.unit_price_usd * rate));
                const total = Number((it.total_bsf !== undefined) ? it.total_bsf : (it.total_usd * rate));
                itemsHtml += `<tr><td style="border:1px solid #000;padding:6px">${code}</td><td style="border:1px solid #000;padding:6px">${desc}</td><td style="border:1px solid #000;padding:6px;text-align:center">${fmt(it.quantity,2)}</td><td style="border:1px solid #000;padding:6px;text-align:right">Bs.F ${fmt(unit,2)}</td><td style="border:1px solid #000;padding:6px;text-align:right">Bs.F ${fmt(total,2)}</td></tr>`;
              } else {
                itemsHtml += `<tr><td style="border:1px solid #000;padding:6px">${code}</td><td style="border:1px solid #000;padding:6px">${desc}</td><td style="border:1px solid #000;padding:6px;text-align:center">${fmt(it.quantity,2)}</td><td style="border:1px solid #000;padding:6px;text-align:right">$ ${fmt(it.unit_price_usd,2)}</td><td style="border:1px solid #000;padding:6px;text-align:right">$ ${fmt(it.total_usd,2)}</td></tr>`;
              }
            });

            let totalsHtml = '';
            if(currency === 'USD' && !j.data.bcv_rate){
              totalsHtml = `<div style="text-align:right;padding:8px;border:1px solid #000;max-width:220px;margin-left:auto"><div>SUB $ ${fmt(j.data.subtotal_usd,2)}</div><div>IVA ${ (j.data.currency && j.data.currency.toUpperCase()==='USD') ? '0' : '16' }%: $ ${fmt(j.data.tax_usd,2)}</div><div style="font-weight:700;margin-top:6px">TOTAL $ ${fmt(j.data.total_usd,2)}</div></div>`;
            } else if(j.data.bcv_rate){
              const sb = (j.data.subtotal_bsf !== undefined) ? j.data.subtotal_bsf : (Number(j.data.subtotal_usd||0) * rate);
              const tb = (j.data.tax_bsf !== undefined) ? j.data.tax_bsf : (Number(j.data.tax_usd||0) * rate);
              const totb = (j.data.total_bsf !== undefined) ? j.data.total_bsf : (Number(j.data.total_usd||0) * rate);
              totalsHtml = `<div style="text-align:right;padding:8px;border:1px solid #000;max-width:220px;margin-left:auto"><div>SUB Bs.F ${fmt(sb,2)}</div><div>IVA 16%: Bs.F ${fmt(tb,2)}</div><div style="font-weight:700;margin-top:6px">TOTAL Bs.F ${fmt(totb,2)}</div></div>`;
            } else {
              totalsHtml = `<div style="text-align:right;padding:8px;border:1px solid #000;max-width:220px;margin-left:auto"><div>SUB $ ${fmt(j.data.subtotal_usd||0,2)}</div><div>IVA 16%: $ ${fmt(j.data.tax_usd||0,2)}</div><div style="font-weight:700;margin-top:6px">TOTAL $ ${fmt(j.data.total_usd||0,2)}</div></div>`;
            }

            // prefer possible field names for client phone/address and rif
            const clientName = j.data.cliente || j.data.nombre || j.data.client_name || '';
            const clientRif = j.data.cliente_rif || j.data.rif || j.data.rif_ci || '';
            const clientPhone = j.data.cliente_phone || j.data.phone || j.data.telefono || j.data.tel || j.data.contact_phone || '';
            const clientAddress = j.data.cliente_address || j.data.address || j.data.direccion || j.data.contact_address || '';
            // si el RIF comienza con 'V' asumimos persona natural: usar etiquetas NOMBRE / CEDULA
            const isNatural = /^\s*V\b[-\s]?/i.test(String(clientRif||''));
            const nameLabel = isNatural ? 'NOMBRE' : 'Empresa';
            const rifLabel = isNatural ? 'CEDULA' : 'RIF';
            const clientHtml = `
              <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
                <div style="flex:1;font-size:14px;line-height:1.35">
                  <div><strong>${nameLabel}:</strong> ${clientName || '&mdash;'}</div>
                  <div><strong>${rifLabel}:</strong> ${clientRif || '&mdash;'}</div>
                  <div><strong>Teléfono:</strong> ${clientPhone || '&mdash;'}</div>
                  <div><strong>Dirección:</strong> ${clientAddress || '&mdash;'}</div>
                </div>
                <div style="text-align:right">
                  <div><strong>Fecha:</strong> ${new Date(j.data.created_at).toLocaleDateString()}</div>
                  <div><strong>Nota Nº:</strong> ${j.data.doc_number||''}</div>
                </div>
              </div>
            `;

            const logoUrl = (typeof location !== 'undefined') ? (location.origin + '/src/img/logo.png') : '/src/img/logo.png'; // usar la ruta proporcionada por el usuario
            const printable = `
              <div style="font-family:Arial,Helvetica,sans-serif;color:#111;font-size:11px">
                <div style="text-align:center;margin-bottom:6px"><img src="${logoUrl}" alt="logo" style="max-height:72px"/></div>
                <div style="text-align:center;font-weight:700;margin-bottom:6px;font-size:11px">J-40048985-7</div>
                <h2 style="text-align:center;margin:6px 0;font-size:11px">Nota de Entrega</h2>
                <div style="border:1px solid #000;padding:8px;margin-bottom:10px;font-size:11px">${clientHtml}</div>
                <table style="width:100%;border-collapse:collapse;margin-bottom:10px;font-size:11px">
                  <colgroup>
                    <col style="width:8%" />
                    <col style="width:56%" />
                    <col style="width:7%" />
                    <col style="width:auto;min-width:80px" />
                    <col style="width:auto;min-width:80px" />
                  </colgroup>
                  <thead>
                    <tr style="background:#f3f3f3">
                      <th style="border:1px solid #000;padding:6px;text-align:left">CODIGO</th>
                      <th style="border:1px solid #000;padding:6px;text-align:left">DESCRIPCIÓN</th>
                      <th style="border:1px solid #000;padding:6px;text-align:center">CANT</th>
                      <th style="border:1px solid #000;padding:6px;text-align:right">PRECIO UNITARIO</th>
                      <th style="border:1px solid #000;padding:6px;text-align:right">TOTAL</th>
                    </tr>
                  </thead>
                  <tbody>${itemsHtml}</tbody>
                </table>
                ${totalsHtml}
                <!-- Observaciones: incluir nota sobre IVA si el documento está en USD -->
                ${(() => {
                  const obs = (currency === 'USD') ? 'Estos precios no incluyen IVA' : (j.data.observaciones || '');
                  const obsHtml = obs ? `<div style="font-size:12px;color:#111">${obs}</div>` : '<div style="height:1px">&nbsp;</div>';
                  return `<div style="margin-top:12px;border:1px solid #000;padding:8px;min-height:60px;font-size:12px"><strong>OBSERVACIONES:</strong>${obsHtml}</div>`;
                })()}
                <div style="margin-top:12px;font-size:11px;color:#666;text-align:center;border-top:1px solid #ddd;padding-top:8px">
                  <div>Av 18 La limpia Sector Miranda la Florida casa 95A-78 - Maracaibo Edo. Zulia</div>
                  <div>Correo: confecciones.hermanos.cantos@hotmail.com &nbsp; / &nbsp; IG: @confeccioneshermanoscantos</div>
                  <div>TIF: 0424-6550993 / 0424-6112097</div>
                </div>
              </div>
            `;

            modalBody.innerHTML = printable + `<div style="display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:12px"><div class="print-instruction" style="font-size:13px;color:#666">Antes de imprimir: desmarque 'Encabezados y pies' en la ventana de impresión para eliminar fecha/URL/página.</div><div style="display:flex;gap:8px;justify-content:flex-end"><button id="printDoc" class="btn-primary">Imprimir</button></div></div>`;
            // attach print handler
            setTimeout(()=>{
              const printBtn = document.getElementById('printDoc');
              if(printBtn) printBtn.addEventListener('click', ()=>{ const w = window.open('','_blank'); w.document.write(`<html><head><title>${j.data.doc_number}</title></head><body>${printable}</body></html>`); w.document.close(); w.focus(); w.print(); });
            }, 60);
            // modal ya se abrió y el contenido fue establecido en 'modalBody' arriba
          } else {
            console.warn('openDoc: respuesta OK=false', j);
            modalBody.innerHTML = `<div style="color:#b91c1c;padding:12px">No se pudo cargar el documento: ${j.error||'respuesta inválida'}</div>`;
          }
        }catch(err){ console.error('openDoc error', err); modalBody.innerHTML = `<div style="color:#b91c1c;padding:12px">Error al cargar documento</div>`; }
      }

  closeDocModal.addEventListener('click', ()=>{ window.closeModal(docModal); currentDocId = null; });
      // delete handler: only attach for admin users; hide button for non-admins
      if(window.currentUserIsAdmin){
        if(deleteDocBtn){
          deleteDocBtn.style.display = '';
          deleteDocBtn.addEventListener('click', async ()=>{
            if(!currentDocId) return;
            if(!(await showConfirm('¿Eliminar este documento? Esta acción no se puede deshacer.'))) return;
            try{
              const r = await fetch(`/api/documentos/${currentDocId}`, { method:'DELETE' });
              const j = await r.json();
              if(j.ok){ window.closeModal(docModal); loadDocs(); (window.showToast||(()=>{}))('Documento eliminado','success'); }
              else (window.showToast||(()=>{}))('Error al eliminar','error');
            }catch(err){ (window.showToast||(()=>{}))('Error al eliminar','error'); }
          });
        }
      } else {
        try{ if(deleteDocBtn) deleteDocBtn.style.display = 'none'; }catch(e){}
      }

      // load on entering view
      navLinks.forEach(a=>{ if(a.dataset.view === 'documentos') a.addEventListener('click', ()=> setTimeout(loadDocs, 150)); });
      // if loaded from hash
      if(location.hash.replace('#','') === 'documentos') loadDocs();
      try{ window.loadDocs = loadDocs; }catch(e){}
    })();

    </script>
    <style>
      @media print{ .print-instruction{ display:none !important } }
      /* Mobile menu link styles: full-width, large touch area, icon + label */
      #mobileMenu .mobile-link{display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;color:var(--text);text-decoration:none;margin:6px 4px;transition:background 140ms,transform 140ms;outline:none}
      #mobileMenu .mobile-link svg{width:20px;height:20px;flex-shrink:0;opacity:0.95}
      #mobileMenu .mobile-link span{flex:1;text-align:left}
      #mobileMenu .mobile-link:focus, #mobileMenu .mobile-link:hover{background:#f3f4f6;transform:translateY(-1px)}
      @media (max-width:800px){
        #mobileMenu{margin:8px}
        #mobileMenu .mobile-link{font-size:16px;padding:14px;border-radius:10px}
      }
    </style>
  </body>
</html>
